- stage: Deploy
    displayName: 'Deploy to Azure'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: DeployContainers
        displayName: 'Deploy Containers'
        steps:
          - task: PowerShell@2
            displayName: 'Deploy API Container'
            inputs:
              targetType: 'inline'
              errorActionPreference: 'continue'
              script: |
                Write-Host "Checking if API container exists..."
                $exists = az container show --resource-group $(resourceGroup) --name nre-portal-api --query "id" -o tsv 2>&1
                
                if ($LASTEXITCODE -eq 0) {
                  Write-Host "Container exists, deleting old one..."
                  az container delete --resource-group $(resourceGroup) --name nre-portal-api --yes
                  Start-Sleep -Seconds 10
                } else {
                  Write-Host "Container doesn't exist yet, creating new one..."
                }
                
                Write-Host "Deploying new API container..."
                az container create `
                  --resource-group $(resourceGroup) `
                  --name nre-portal-api `
                  --image $(containerRegistry)/nre-portal-api:latest `
                  --registry-login-server $(containerRegistry) `
                  --registry-username $(acrUsername) `
                  --registry-password $(acrPassword) `
                  --dns-name-label uas-nre-api `
                  --ports 8080 `
                  --cpu 1 --memory 1.5 `
                  --location $(location) `
                  --environment-variables `
                    ASPNETCORE_ENVIRONMENT=Development `
                    ASPNETCORE_URLS=http://+:8080
                
                if ($LASTEXITCODE -eq 0) {
                  Write-Host "✅ API container deployed successfully!"
                } else {
                  Write-Host "❌ API deployment failed!"
                  exit 1
                }

          - task: PowerShell@2
            displayName: 'Deploy MVC Container'
            inputs:
              targetType: 'inline'
              errorActionPreference: 'continue'
              script: |
                Write-Host "Getting API URL..."
                $apiUrl = az container show --resource-group $(resourceGroup) --name nre-portal-api --query ipAddress.fqdn -o tsv
                Write-Host "API URL: http://$apiUrl:8080"
                
                Write-Host "Checking if MVC container exists..."
                $exists = az container show --resource-group $(resourceGroup) --name nre-portal-mvc --query "id" -o tsv 2>&1
                
                if ($LASTEXITCODE -eq 0) {
                  Write-Host "Container exists, deleting old one..."
                  az container delete --resource-group $(resourceGroup) --name nre-portal-mvc --yes
                  Start-Sleep -Seconds 10
                } else {
                  Write-Host "Container doesn't exist yet, creating new one..."
                }
                
                Write-Host "Deploying new MVC container..."
                az container create `
                  --resource-group $(resourceGroup) `
                  --name nre-portal-mvc `
                  --image $(containerRegistry)/nre-portal-mvc:latest `
                  --registry-login-server $(containerRegistry) `
                  --registry-username $(acrUsername) `
                  --registry-password $(acrPassword) `
                  --dns-name-label uas-nre-mvc `
                  --ports 8080 `
                  --cpu 1 --memory 1.5 `
                  --location $(location) `
                  --environment-variables `
                    ASPNETCORE_ENVIRONMENT=Development `
                    ASPNETCORE_URLS=http://+:8080 `
                    ApiBaseUrl=http://${apiUrl}:8080
                
                if ($LASTEXITCODE -eq 0) {
                  $mvcUrl = az container show --resource-group $(resourceGroup) --name nre-portal-mvc --query ipAddress.fqdn -o tsv
                  
                  Write-Host ""
                  Write-Host "========================================="
                  Write-Host "✅ Deployment Complete!"
                  Write-Host "========================================="
                  Write-Host "API: http://$apiUrl:8080/swagger"
                  Write-Host "MVC: http://$mvcUrl:8080"
                  Write-Host "========================================="
                } else {
                  Write-Host "❌ MVC deployment failed!"
                  exit 1
                }
@model MVC_NRE_Portal.Models.PrivateInstallationViewModel

@{
    ViewData["Title"] = "Entering my private installation";
}

<h1>Entering my private installation</h1>
<p class="text-muted">Home &gt; Private installation</p>

@await Html.PartialAsync("_PrivateInstallationTabs", Model)

<form asp-action="Navigate" method="post" class="card mt-2" id="pi-form">
    @Html.AntiForgeryToken()
    <div class="card-body">
        <!-- Persist wizard state + previously entered values across steps -->
        <input type="hidden" asp-for="CurrentStep" />
        <input type="hidden" asp-for="Address" />
        <input type="hidden" asp-for="Canton" />
        <input type="hidden" asp-for="Municipality" />
        <input type="hidden" asp-for="Latitude" />
        <input type="hidden" asp-for="Longitude" />
        <input type="hidden" asp-for="EnergyType" />
        <input type="hidden" asp-for="IntegrationType" />
        <input type="hidden" asp-for="PvCellType" />
        <input type="hidden" asp-for="InstalledCapacityKW" />
        <input type="hidden" asp-for="LengthM" />
        <input type="hidden" asp-for="WidthM" />
        <input type="hidden" asp-for="AreaM2" />
        <input type="hidden" asp-for="Azimuth" />
        <input type="hidden" asp-for="RoofSlope" />

        @* STEP 1 *@
        @if (Model.CurrentStep == 1)
        {
            <h5>Location</h5>
            <p class="text-muted small">Later: geolocation, canton, municipality…</p>
        }
        @* STEP 2 *@
        else if (Model.CurrentStep == 2)
        {
            <h5>Type of installation</h5>
            <p class="text-muted small">Later: Energy type, integration, PV cell type…</p>
        }
        @* STEP 3: Orientation *@
        else if (Model.CurrentStep == 3)
        {
            <h5>Orientation</h5>
            <div class="row g-3">
                <div class="col-md-4">
                    <label asp-for="Azimuth" class="form-label">Field orientation (azimuth) [&deg;]</label>
                    <input asp-for="Azimuth" class="form-control" id="Azimuth_input" />
                    <span class="form-text">-180 … +180 (0 ≈ south)</span>
                    <span asp-validation-for="Azimuth" class="text-danger"></span>
                </div>
                <div class="col-md-4">
                    <label asp-for="RoofSlope" class="form-label">Slope of the roof [&deg;]</label>
                    <input asp-for="RoofSlope" class="form-control" id="RoofSlope_input" />
                    <span class="form-text">0 … 90</span>
                    <span asp-validation-for="RoofSlope" class="text-danger"></span>
                </div>
            </div>
        }
        @* STEP 4: Area *@
        else if (Model.CurrentStep == 4)
        {
            <h5>Area</h5>
            <div class="row g-3">
                <div class="col-md-3">
                    <label asp-for="LengthM" class="form-label">Length [m]</label>
                    <input asp-for="LengthM" class="form-control" id="LengthM_input" />
                    <span asp-validation-for="LengthM" class="text-danger"></span>
                </div>
                <div class="col-md-3">
                    <label asp-for="WidthM" class="form-label">Width [m]</label>
                    <input asp-for="WidthM" class="form-control" id="WidthM_input" />
                    <span asp-validation-for="WidthM" class="text-danger"></span>
                </div>
                <div class="col-md-3">
                    <label asp-for="AreaM2" class="form-label">Area [m²]</label>
                    <input asp-for="AreaM2" class="form-control" id="AreaM2_input" />
                    <span class="form-text">Auto-computed if length &amp; width are set</span>
                    <span asp-validation-for="AreaM2" class="text-danger"></span>
                </div>
            </div>
        }
    </div>

    <div class="card-footer d-flex gap-2">
        <button type="submit" name="direction" value="prev"
                class="btn btn-outline-secondary" @(Model.CurrentStep == 1 ? "disabled" : "")>
            &larr; Previous
        </button>
        <button type="submit" name="direction" value="next"
                class="btn btn-primary ms-auto" @(Model.CurrentStep == 4 ? "disabled" : "")>
            Next &rarr;
        </button>
    </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Grab the visible inputs (the hidden ones have the same names)
        const lengthInput = document.getElementById('LengthM_input');
        const widthInput  = document.getElementById('WidthM_input');
        const areaInput   = document.getElementById('AreaM2_input');

        function parseNum(el) {
            if (!el) return NaN;
            const v = (el.value || '').replace(',', '.');
            const n = parseFloat(v);
            return isNaN(n) ? NaN : n;
        }

        function syncArea() {
            if (!lengthInput || !widthInput || !areaInput) return;
            const L = parseNum(lengthInput);
            const W = parseNum(widthInput);
            if (!isNaN(L) && !isNaN(W)) {
                const A = Math.round(L * W * 100) / 100;
                areaInput.value = A;

                // also push to the hidden field so server sees it
                const hiddenArea = document.querySelector('input[type="hidden"][name="AreaM2"]');
                if (hiddenArea) hiddenArea.value = A;
            }
        }

        // compute immediately and on changes (Area step)
        document.addEventListener('DOMContentLoaded', function () {
            if (lengthInput) lengthInput.addEventListener('input', syncArea);
            if (widthInput)  widthInput.addEventListener('input',  syncArea);
            syncArea();

            // Persist values when clicking tabs
            document.querySelectorAll('.nav-tabs a').forEach(function (a) {
                a.addEventListener('click', function (e) {
                    e.preventDefault();

                    // keep Area in sync before we serialize
                    syncArea();

                    const form = document.getElementById('pi-form');
                    const fd = new FormData(form);
                    const url = new URL(a.href, window.location.origin);

                    // add every form field (hidden + visible)
                    for (const [k, v] of fd.entries()) {
                        url.searchParams.set(k, v);
                    }

                    window.location.href = url.toString();
                });
            });
        });
    </script>
}

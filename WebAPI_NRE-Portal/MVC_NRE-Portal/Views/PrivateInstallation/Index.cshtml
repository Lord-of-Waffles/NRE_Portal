@model MVC_NRE_Portal.Models.PrivateInstallationViewModel

@{
    ViewData["Title"] = "Entering my private installation";
}

<h1>Entering my private installation</h1>
<p class="text-muted">Home &gt; Private installation</p>

@await Html.PartialAsync("_PrivateInstallationTabs", Model)

<form asp-action="Navigate" method="post" class="card mt-2" id="pi-form">
    @Html.AntiForgeryToken()
    <div class="card-body">
        <!-- Hidden fields to persist data across steps -->
        <input type="hidden" asp-for="CurrentStep" />
        <input type="hidden" asp-for="Address" />
        <input type="hidden" asp-for="Canton" />
        <input type="hidden" asp-for="Municipality" />
        <input type="hidden" asp-for="Latitude" />
        <input type="hidden" asp-for="Longitude" />
        <input type="hidden" asp-for="EnergyType" />
        <input type="hidden" asp-for="IntegrationType" />
        <input type="hidden" asp-for="PvCellType" />
        <input type="hidden" asp-for="InstalledCapacityKW" />
        <input type="hidden" asp-for="LengthM" />
        <input type="hidden" asp-for="WidthM" />
        <input type="hidden" asp-for="AreaM2" />
        <input type="hidden" asp-for="Azimuth" />
        <input type="hidden" asp-for="RoofSlope" />

        @if (Model.CurrentStep == 1)
        {
            <h5>Location</h5>
            <p class="text-muted small">Later: geolocation, canton, municipality…</p>
        }
        else if (Model.CurrentStep == 2)
        {
            <h5>Type of installation</h5>
            <p class="text-muted small">Later: Energy type, integration, PV cell type…</p>
        }
        else if (Model.CurrentStep == 3)
        {
            <h5>Orientation</h5>
            <div class="row g-3">
                <div class="col-md-4">
                    <label asp-for="Azimuth" class="form-label">Field orientation (azimuth) [&deg;]</label>
                    <input asp-for="Azimuth" class="form-control" id="Azimuth_input" />
                    <span class="form-text">-180 … +180 (0 ≈ south)</span>
                </div>
                <div class="col-md-4">
                    <label asp-for="RoofSlope" class="form-label">Slope of the roof [&deg;]</label>
                    <input asp-for="RoofSlope" class="form-control" id="RoofSlope_input" />
                    <span class="form-text">0 … 90</span>
                </div>
            </div>
        }
        else if (Model.CurrentStep == 4)
        {
            <h5>Area</h5>
            <div class="row g-3">
                <div class="col-md-3">
                    <label asp-for="LengthM" class="form-label">Length [m]</label>
                    <input asp-for="LengthM" class="form-control" id="LengthM_input" />
                </div>
                <div class="col-md-3">
                    <label asp-for="WidthM" class="form-label">Width [m]</label>
                    <input asp-for="WidthM" class="form-control" id="WidthM_input" />
                </div>
                <div class="col-md-3">
                    <label asp-for="AreaM2" class="form-label">Area [m²]</label>
                    <input asp-for="AreaM2" class="form-control" id="AreaM2_input" />
                    <span class="form-text">Auto-computed if length &amp; width are set</span>
                </div>
            </div>
        }
    </div>

    <div class="card-footer d-flex gap-2">
        <button type="submit" name="direction" value="prev"
                class="btn btn-outline-secondary" @(Model.CurrentStep == 1 ? "disabled" : "")>
            &larr; Previous
        </button>

        @if (Model.CurrentStep < 4)
        {
            <button type="submit" name="direction" value="next"
                    class="btn btn-primary ms-auto">
                Next &rarr;
            </button>
        }
        else
        {
            <button class="btn btn-success ms-auto"
                    formaction="@(Url.Action("Save", "PrivateInstallation"))"
                    formmethod="post"
                    id="saveBtn"
                    disabled>
                💾 Save installation
            </button>
        }
    </div>
</form>

@section Scripts {
    <script>
        // --- helper utils ---
        const get = id => document.getElementById(id);
        const hidden = name => document.querySelector(`input[type="hidden"][name="${name}"]`);
        const setHidden = (n, v) => { if (hidden(n)) hidden(n).value = v; };

        function parseNum(el) {
            if (!el) return NaN;
            const v = (el.value || '').replace(',', '.');
            const n = parseFloat(v);
            return isNaN(n) ? NaN : n;
        }

        // --- Area auto-compute ---
        function syncArea() {
            const L = parseNum(get('LengthM_input'));
            const W = parseNum(get('WidthM_input'));
            if (!isNaN(L) && !isNaN(W)) {
                const A = Math.round(L * W * 100) / 100;
                get('AreaM2_input').value = A;
                setHidden('AreaM2', A);
            }
            checkRequired();
        }

        // --- Validate required fields before enabling Save ---
        function checkRequired() {
            const az = hidden('Azimuth')?.value || get('Azimuth_input')?.value || "";
            const slope = hidden('RoofSlope')?.value || get('RoofSlope_input')?.value || "";
            const area = hidden('AreaM2')?.value || get('AreaM2_input')?.value || "";
            const areaNum = parseFloat(area.replace(',', '.'));

            const valid = az !== "" && slope !== "" && !isNaN(areaNum) && areaNum > 0;
            const btn = get('saveBtn');
            if (btn) btn.disabled = !valid;
        }

        // --- Tab persistence ---
        function persistTabs() {
            document.querySelectorAll('.nav-tabs a').forEach(a => {
                a.addEventListener('click', e => {
                    e.preventDefault();
                    syncArea();
                    const form = document.getElementById('pi-form');
                    const fd = new FormData(form);
                    const url = new URL(a.href, window.location.origin);
                    for (const [k, v] of fd.entries()) url.searchParams.set(k, v);
                    window.location.href = url.toString();
                });
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            persistTabs();
            ['LengthM_input', 'WidthM_input'].forEach(id => {
                const el = get(id);
                if (el) el.addEventListener('input', syncArea);
            });
            ['Azimuth_input', 'RoofSlope_input'].forEach(id => {
                const el = get(id);
                if (el) el.addEventListener('input', e => {
                    setHidden(e.target.name, e.target.value);
                    checkRequired();
                });
            });
            syncArea();
            checkRequired();
        });
    </script>
}
